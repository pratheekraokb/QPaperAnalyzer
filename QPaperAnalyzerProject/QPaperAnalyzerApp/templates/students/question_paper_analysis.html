{% extends 'students/students_base.html' %}

{% block title %}Student Dashboard{% endblock %}

{% block style %}
<style>
    .upload-container {
        width: 100%;
        height: 40vh;  /* 40% of the viewport height */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        border: 2px dashed #007bff;
        border-radius: 8px;
        background-color: #f8f9fa;
        color: #007bff;
        text-align: center;
        font-size: 18px;
    }

    .upload-container input[type="file"] {
        display: none;
    }

    .upload-container label {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    .upload-container label:hover {
        background-color: #0056b3;
    }

    .filename {
        margin-top: 10px;
        font-size: 16px;
        color: #333;
        font-weight: bold;
    }

    .submit-btn {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        opacity: 0.5;
    }

    .submit-btn:enabled {
        opacity: 1;
    }

    .submit-btn:disabled {
        cursor: not-allowed;
    }

    .processing {
        display: none; /* Initially hidden */
        text-align: center;
        margin-top: 20px;
    }
    
    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3); /* Light gray border */
        border-top: 4px solid #3498db; /* Blue color for the spinner */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite; /* Spin animation */
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<h1>Analyse</h1>

<form id="uploadForm" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="upload-container">
        <div>
            <p>Upload Excel File</p>
            <label for="excelFile">Choose an Excel File</label>
            <input type="file" id="excelFile" name="excel_file" accept=".xlsx, .xls" />
            <p class="filename" id="filename">No file chosen</p>
            <button class="submit-btn" id="submitBtn" type="button" disabled>Submit</button>
        </div>

        <div class="processing" style="display: none;">
            <p>Please wait, processing...</p>
            <div class="loading-spinner"></div>
        </div>
    </div>
</form>

<script>
    // Enable the submit button and display the filename when a file is chosen
    document.getElementById('excelFile').addEventListener('change', function() {
        const filenameDisplay = document.getElementById('filename');
        const submitBtn = document.getElementById('submitBtn');
        
        if (this.files.length > 0) {
            filenameDisplay.textContent = 'Selected file: ' + this.files[0].name;
            submitBtn.disabled = false; // Enable the submit button
        } else {
            filenameDisplay.textContent = 'No file chosen';
            submitBtn.disabled = true; // Disable the submit button if no file is selected
        }
    });

    document.getElementById('submitBtn').addEventListener('click', function() {
        let spin_flag = 0;
        const form = document.getElementById('uploadForm');
        const formData = new FormData(form); // Create FormData from the form
    
        // Show the processing section with the spinner
        const processingDiv = document.querySelector('.processing');
        processingDiv.style.display = 'block'; // Show the processing div
    
        // Make the AJAX request to upload the file
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "upload_file" %}', true); // Ensure the URL is correct
    
        // Set up the callback function to handle the response
        xhr.onload = function() {
            // Hide the processing div once the request is complete
            processingDiv.style.display = 'none'; // Hide the spinner and processing message
    
            if (xhr.status === 200) {
                // Parse the JSON response
                const response = JSON.parse(xhr.responseText);
    
                // Handle the response
                if (response.status === 600) {
                    
                    const filename = response.file_name;  // Extract the filename
    
                    // Send the second POST request to /api/QPaperExcelToDB/ with the filename
                    const secondRequest = new XMLHttpRequest();
                    secondRequest.open('POST', '/api/QPaperExcelToDB/', true);
                    secondRequest.setRequestHeader('Content-Type', 'application/json');
    
                    const requestBody = JSON.stringify({
                        filename: filename // Send the filename as part of the request
                    });
    
                    // Handle the second request response
                    secondRequest.onload = function() {
                        if (secondRequest.status === 200) {
                            const secondResponse = JSON.parse(secondRequest.responseText);
                            spin_flag = 1;
                        
                            // Stop the loading spinner when spin_flag becomes 1
                            if (spin_flag === 1) {
                                processingDiv.style.display = 'none'; // Hide the processing div
                            }
                        } else {
                            spin_flag = 1;
                            alert('Error in processing the question paper data.');
                        }
                    };
    
                    secondRequest.send(requestBody); // Send the second request with the filename
                } else {
                    alert(response.status_msg || 'File upload failed!');
                }
            } else {
                alert('An error occurred during file upload.');
            }
        };
    
        // Send the FormData (file)
        xhr.send(formData);
    });
</script>

{% endblock %}
